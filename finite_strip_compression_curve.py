import math
import numpy as np
from scipy import linalg
from channel import channel
from I_beam import I_beam
from RHS import RHS
from stress_from_strain import stress_from_strain
import time
import matplotlib.pyplot as plt
import pandas as pd 
from finite_strip_Compression import finitestrip_shape
import os
import xlrd
from xlutils.copy import copy
from xlwt import Workbook

#C:\Users\saulg\Documents\year 4\IIB_Project\code

def find_nearest(array, value):
    array = np.asarray(array)
    idx = (np.abs(array - value)).argmin()
    return idx

"""
THIS_FOLDER = os.path.dirname(os.path.abspath(__file__))
my_file = os.path.join(THIS_FOLDER, 'Data','beam_column_data.xlsx')
book = xlrd.open_workbook(my_file)
# get the first worksheet
sheet = book.sheet_by_index(1)

#read a row slice
row_number = 
if row_number<73:
     row = sheet.row_slice(rowx=row_number,
                         start_colx=28,
                         end_colx=45)
     shape = "RHS"

     L, b, d, r, t_flange, t_web, c, spr, s_ult, n, Eel, s_pl, curve_pl = [row[0].value, row[2].value, row[1].value, row[4].value, row[3].value, row[3].value, row[3].value, row[9].value, row[10].value, row[13].value, row[12].value, row[15].value, row[16].value]
else:
     row = sheet.row_slice(rowx=row_number,
                         start_colx=10,
                         end_colx=33)
     shape = "I Beam"

     L, b, d, r, t_flange, t_web, c, spr, s_ult, n, Eel, s_pl, curve_pl = [row[0].value, row[2].value, row[1].value, row[5].value, row[4].value, row[3].value, row[3].value, row[16].value, row[17].value, row[18].value, row[19].value, row[21].value, row[22].value]

"""
points = [ [20.000000000000, 1126.375108544497
], [20.470000000000, 1078.170545748579
], [20.940000000000, 1033.187270138724
], [21.430000000000, 989.418076302094
], [21.930000000000, 947.758752098292
], [22.450000000000, 907.365834376925
], [22.970000000000, 869.699110715103
], [23.510000000000, 833.213733060626
], [24.060000000000, 798.564514231212
], [24.620000000000, 765.659847270774
], [25.200000000000, 733.882771547026
], [25.790000000000, 703.749584022597
], [26.390000000000, 675.172500038810
], [27.000000000000, 648.068211404150
], [27.640000000000, 621.557363991359
], [28.280000000000, 596.845692104721
], [28.940000000000, 573.079962181037
], [29.620000000000, 550.258317541364
], [30.310000000000, 528.675517119967
], [31.020000000000, 507.976729304414
], [31.740000000000, 488.412776268300
], [32.490000000000, 469.426342299692
], [33.250000000000, 451.508682157509
], [34.020000000000, 434.592873375850
], [34.820000000000, 418.221540916531
], [35.630000000000, 402.785650561657
], [36.460000000000, 388.054167323205
], [37.320000000000, 373.847500006042
], [38.190000000000, 360.474361510414
], [39.080000000000, 347.741943182713
], [40.000000000000, 335.499923127964
], [40.930000000000, 323.991784735687
], [41.890000000000, 312.946548073588
], [42.870000000000, 302.468854317935
], [43.870000000000, 292.535439166021
], [44.890000000000, 283.123562820825
], [45.940000000000, 274.128541921996
], [47.020000000000, 265.546779408977
], [48.110000000000, 257.514864184674
], [49.240000000000, 249.797675458050
], [50.390000000000, 242.525816459659
], [51.570000000000, 235.621589330220
], [52.770000000000, 229.129378768279
], [54.010000000000, 222.932918090062
], [55.270000000000, 217.123944546450
], [56.560000000000, 211.642043754345
], [57.880000000000, 206.478493359946
], [59.230000000000, 201.624381354755
], [60.620000000000, 197.039123835154
], [62.040000000000, 192.750653691338
], [63.490000000000, 188.749491248259
], [64.970000000000, 185.026320121665
], [66.490000000000, 181.550251211940
], [68.040000000000, 178.338346807350
], [69.630000000000, 175.363875037462
], [71.260000000000, 172.623677842691
], [72.920000000000, 170.128453903486
], [74.630000000000, 167.844498949525
], [76.370000000000, 165.794852486162
], [78.160000000000, 163.952024536133
], [79.990000000000, 162.324514204415
], [81.850000000000, 160.915199911372
], [83.770000000000, 159.699209033888
], [85.730000000000, 158.688804525383
], [87.730000000000, 157.879891864379
], [89.780000000000, 157.266003120969
], [91.880000000000, 156.846188579777
], [94.030000000000, 156.619326934437
], [96.220000000000, 156.583890977235
], [98.470000000000, 156.738222689741
], [100.770000000000, 157.081466351042
], [103.130000000000, 157.614716948910
], [105.540000000000, 158.335167984768
], [108.010000000000, 159.245069181923
], [110.530000000000, 160.339862860796
], [113.110000000000, 161.622834469768
], [115.760000000000, 163.099527534583
], [118.460000000000, 164.758189922082
], [121.230000000000, 166.610176414901
], [124.060000000000, 168.648369102461
], [126.960000000000, 170.879103888089
], [129.930000000000, 173.301769930343
], [132.970000000000, 175.915182709265
], [136.080000000000, 178.717528214810
], [139.260000000000, 181.706296705896
], [142.510000000000, 184.878205925838
], [145.840000000000, 188.239363993323
], [149.250000000000, 191.785542971985
], [152.740000000000, 195.511265424200
], [156.310000000000, 199.409669473107
], [159.960000000000, 203.472362608712
], [163.700000000000, 207.700646276985
], [167.530000000000, 212.082942566527
], [171.440000000000, 216.593834747462
], [175.450000000000, 221.240127264525
], [179.550000000000, 225.991377660381
], [183.740000000000, 230.825840083326
], [188.040000000000, 235.741568454758
], [192.430000000000, 240.687410754137
], [196.930000000000, 245.654173494688
], [201.530000000000, 250.595455514472
], [206.240000000000, 255.483373321130
], [211.060000000000, 260.275877227611
], [216.000000000000, 264.937718886430
], [221.050000000000, 269.412649496219
], [226.210000000000, 273.654321441769
], [231.500000000000, 277.631854920626
], [236.910000000000, 281.291844620917
], [242.450000000000, 284.599407600668
], [248.110000000000, 287.513180006146
], [253.910000000000, 290.014881745195
], [259.850000000000, 292.083092771068
], [265.920000000000, 293.705035153266
], [272.130000000000, 294.885601955407
], [278.490000000000, 295.638184230639
], [285.000000000000, 295.984331552889
], [291.660000000000, 295.955619564743
], [298.480000000000, 295.591192490567
], [305.460000000000, 294.936168415767
], [312.600000000000, 294.040372087387
], [319.900000000000, 292.956256865068
], [327.380000000000, 291.733645029838
], [335.030000000000, 290.426339631922
], [342.860000000000, 289.083266463843
], [350.870000000000, 287.752474504839
], [359.070000000000, 286.477289625427
], [367.470000000000, 285.297977418181
], [376.050000000000, 284.255142001268
], [384.840000000000, 283.379336570748
], [393.840000000000, 282.701916050917
], [403.040000000000, 282.250928374661
], [412.460000000000, 282.049502520623
], [422.100000000000, 282.119180196094
], [431.970000000000, 282.478813838032
], [442.060000000000, 283.143792009103
], [452.400000000000, 284.129861953119
], [462.970000000000, 285.446604686651
], [473.790000000000, 287.105377713180
], [484.860000000000, 289.113374172214
], [496.190000000000, 291.477510959905
], [507.790000000000, 294.203269669646
], [519.660000000000, 297.291853430185
], [531.810000000000, 300.744751440248
], [544.230000000000, 304.555200080302
], [556.950000000000, 308.726116162285
], [569.970000000000, 313.248818681347
], [583.290000000000, 318.110901331421
], [596.920000000000, 323.299751375310
], [610.880000000000, 328.802746107413
], [625.150000000000, 334.586510574057
], [639.760000000000, 340.631920375626
], [654.720000000000, 346.905566995169
], [670.020000000000, 353.358030640242
], [685.680000000000, 359.943993147386
], [701.700000000000, 366.600246429654
], [718.100000000000, 373.261353936141
], [734.890000000000, 379.846043911543
], [752.060000000000, 386.253546687282
], [769.640000000000, 392.386261079312
], [787.630000000000, 398.123824059032
], [806.040000000000, 403.339991176813
], [824.870000000000, 407.899628681795
], [844.150000000000, 411.672533672065
], [863.880000000000, 414.524888579960
], [884.070000000000, 416.336744950454
], [904.740000000000, 417.007358872656
], [925.880000000000, 416.462065027721
], [947.520000000000, 414.659229037460
], [969.670000000000, 411.592519190391
], [992.330000000000, 407.294752790739
], [1015.520000000000, 401.829515674437
], [1039.260000000000, 395.287113306772
], [1063.540000000000, 387.787534113953
], [1088.400000000000, 379.448918171774
], [1113.840000000000, 370.407175428376
], [1139.870000000000, 360.794832614911
], [1166.510000000000, 350.735138827659
], [1193.780000000000, 339.448912007416
], [1221.680000000000, 325.091937127073
], [1250.230000000000, 311.349111164387
], [1279.450000000000, 298.194784949047
], [1309.350000000000, 285.608567249764
], [1339.960000000000, 273.562516607334
], [1371.270000000000, 262.045064315710
], [1403.320000000000, 251.026217185576
], [1436.120000000000, 240.488233648368
], [1469.680000000000, 230.413495303195
], [1504.030000000000, 220.779159948044
], [1539.190000000000, 211.566597477825
], [1575.160000000000, 202.762746662796
], [1611.970000000000, 194.347446127001
], [1649.650000000000, 186.301979762127
], [1688.200000000000, 178.614696403202
], [1727.660000000000, 171.266372251673
], [1768.040000000000, 164.244486545724
], [1809.360000000000, 157.535077411555
], [1851.650000000000, 151.123304954745
], [1894.920000000000, 144.998010984747
], [1939.210000000000, 139.144335559825
], [1984.540000000000, 133.550983816313
], [2030.920000000000, 128.208190391353
], [2078.380000000000, 123.104213912653
], [2126.960000000000, 118.227035627404
], [2176.670000000000, 113.568240700462
], [2227.540000000000, 109.117795922581
], [2279.600000000000, 104.866212484810
], [2332.880000000000, 100.804511172361
], [2387.410000000000, 96.924184260250
], [2443.200000000000, 93.218427469845
], [2500.310000000000, 89.677506092930
], [2558.740000000000, 85.939375284300
], [2618.550000000000, 82.116195626759
], [2679.750000000000, 78.459276771883
], [2742.380000000000, 74.961478653014
], [2806.470000000000, 71.616515220511
], [2872.060000000000, 68.417824403214
], [2939.190000000000, 65.359155781026
], [3007.880000000000, 62.435378413473
], [3078.180000000000, 59.640263440080
], [3150.120000000000, 56.968676897300
], [3223.750000000000, 54.414966921499
], [3299.090000000000, 51.974751101263
], [3376.200000000000, 49.642531506646
], [3455.110000000000, 47.414003720190
], [3535.860000000000, 45.284726359584
], [3618.500000000000, 43.250210442905
], [3703.070000000000, 41.306434511265
], [3789.620000000000, 39.449326907558
], [3878.190000000000, 37.675229072637
], [3968.830000000000, 35.980436045710
], [4061.590000000000, 34.361434269128
], [4156.510000000000, 32.815032833249
], [4253.660000000000, 31.337724835241
], [4353.070000000000, 29.926781177196
], [4454.810000000000, 28.579019194609
], [4558.930000000000, 27.291700890625
], [4665.480000000000, 26.062208051629
], [4774.520000000000, 24.887927100749
], [4886.110000000000, 23.766380360873
], [5000.310000000000, 22.695224184176
], [5117.170000000000, 21.672294126098
], [5236.770000000000, 20.695291487416
], [5359.160000000000, 19.762272514528
], [5484.420000000000, 18.871166288572
], [5612.600000000000, 18.020212310256
], [5743.770000000000, 17.207597131348
], [5878.020000000000, 16.431486164766
], [6015.400000000000, 15.690367487942
], [6155.990000000000, 14.982629334947
], [6299.860000000000, 14.306800337594
], [6447.100000000000, 13.661381738382
], [6597.780000000000, 13.045052143291
], [6751.980000000000, 12.456507892029
], [6909.790000000000, 11.894464432140
], [7071.280000000000, 11.357781274616
], [7236.550000000000, 10.845279700308
], [7405.680000000000, 10.355892710208
], [7578.770000000000, 9.888554591701
], [7755.900000000000, 9.442298986029
], [7937.170000000000, 9.016164256272
], [8122.670000000000, 8.609265718194
], [8312.510000000000, 8.220718419104
], [8506.790000000001, 7.849685020858
], [8705.610000000001, 7.495391833075
], [8909.080000000000, 7.157074211867
], [9117.299999999999, 6.834020809912
], [9330.389999999999, 6.525551935473
], [9548.459999999999, 6.230997203375
], [9771.620000000001, 5.949732764294
], [10000.000000000000, 5.681169210505]]
x=[]
y=[]
for p in points:
     x.append(p[0])
     y.append(p[1])
n = 300
max_L = 10000
min_L = 20
r = (max_L/min_L) ** (1/(n-1))
Stress = []
Stress_1 = []
Length = []
Length_factor= False
S_2 = 300

tic = time.perf_counter()
for i in range(n):
     L = min_L * r**i
     Length.append(L)
     if i == 0:
          sg = 300
     elif i == 1:
          sg = s1
          s2 = s1
     else:
          sg = abs(2 * s1 - s2)
          s3 = s2
          s2 = s1
     
     S = finitestrip_shape(L, shape = "channel", b = 45, d = 125, r = 0.1, t_flange = 1.524, t_web = 1.524, c = 15, Eel = 203000, spr = 3280000000, n = 7.5, v = 0.3, k = -0.46, sg = sg)
     s1 = S 
     if Length_factor:
          Stress_1.append(S)
          for n in range(2,round(L/Length[0])+1):
               S_2 = Stress[find_nearest(Length, L/n)]
               if S > S_2:
                    S = S_2
     Stress.append(S)
toc = time.perf_counter()
print(f"Done in {toc - tic:0.4f} seconds")


if Length_factor:
     plt.semilogx(Length, Stress_1, linewidth = 0.4, color = "black", label='Singe Half Wavelength')
     plt.semilogx(Length, Stress, linewidth = 1.2, color = "black", label='Multiple Half Wavelengths')
else:
     plt.semilogx(Length, Stress, linewidth = 0.6, color = "black", label='My code')
plt.semilogx(x, y, linewidth = 0.6, color = "red", label='CUFSM')    

#plt.semilogx([1000], [151], 'rx',  label='Buckling')
#plt.semilogx([1000], [169], 'bx',  label='Failure')
plt.xlabel('L / mm')
plt.ylabel('Stress / MPa')
plt.grid(True,'both')
plt.legend()
plt.show()






"""
print(finitestrip_shape(L = 1000, shape = "channel", b = 138.60, d = 202.05, r = 5, t_flange = 6.11, t_web = 6.01, c = 23, Eel = 195000, spr = 520, n = 7.5, v = 0.3, k = -0.46))

x1=[]
y1=[]

for f in file:
     x1.append(f[0])
     y1.append(f[1])
plt.semilogx(x1, y1, linewidth = 0.4, color = "red", label='CUFSM')"""